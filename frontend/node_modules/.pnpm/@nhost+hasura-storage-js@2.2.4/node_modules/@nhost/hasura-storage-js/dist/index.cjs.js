"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const S=require("fetch-ponyfill"),F=require("form-data"),d=require("xstate");let _=globalThis.fetch;typeof EdgeRuntime!="string"&&(_=S().fetch);const P=async(t,e,{accessToken:r,name:s,fileId:a,bucketId:o,adminSecret:i,onUploadProgress:l,headers:u={}}={})=>{var y;const p={...u};o&&e.append("bucket-id",o),i&&(p["x-hasura-admin-secret"]=i),r&&(p.Authorization=`Bearer ${r}`);const O=`${t}/files`;if(typeof XMLHttpRequest=="undefined")try{const c=await _(O,{method:"POST",headers:p,body:e}),n=await c.json();return c.ok?{fileMetadata:n,error:null}:{error:{status:c.status,message:((y=n==null?void 0:n.error)==null?void 0:y.message)||c.statusText,error:c.statusText},fileMetadata:null}}catch(c){return{error:{status:0,message:c.message,error:c.message},fileMetadata:null}}return new Promise(c=>{let n=new XMLHttpRequest;n.responseType="json",n.onload=()=>{var g,f,D,U,T;return n.status<200||n.status>=300?c({fileMetadata:null,error:{error:(f=(g=n.response)==null?void 0:g.error)!=null?f:n.response,message:(T=(U=(D=n.response)==null?void 0:D.error)==null?void 0:U.message)!=null?T:n.response,status:n.status}}):c({fileMetadata:n.response,error:null})},n.onerror=()=>c({fileMetadata:null,error:{error:n.statusText,message:n.statusText,status:n.status}}),l&&n.upload.addEventListener("progress",l,!1),n.open("POST",O,!0),Object.entries(p).forEach(([g,f])=>{n.setRequestHeader(g,f)}),n.send(e)})},{fetch:L}=S();class R{constructor({url:e}){this.url=e}async uploadFormData({formData:e,headers:r,bucketId:s}){const{error:a,fileMetadata:o}=await P(this.url,e,{accessToken:this.accessToken,adminSecret:this.adminSecret,bucketId:s,headers:r});return a?{fileMetadata:null,error:a}:o&&!("processedFiles"in o)?{fileMetadata:{processedFiles:[o]},error:null}:{fileMetadata:o,error:null}}async uploadFile({file:e,bucketId:r,id:s,name:a}){const o=new F;o.append("file[]",e),o.append("metadata[]",JSON.stringify({id:s,name:a}));const{error:i,fileMetadata:l}=await P(this.url,o,{accessToken:this.accessToken,adminSecret:this.adminSecret,bucketId:r,fileId:s,name:a});return i?{fileMetadata:null,error:i}:l&&"processedFiles"in l?{fileMetadata:l.processedFiles[0],error:null}:{fileMetadata:l,error:null}}async getPresignedUrl(e){try{const{fileId:r}=e,s=await L(`${this.url}/files/${r}/presignedurl`,{method:"GET",headers:this.generateAuthHeaders()});if(!s.ok)throw new Error(await s.text());return{presignedUrl:await s.json(),error:null}}catch(r){return{presignedUrl:null,error:r}}}async delete(e){try{const{fileId:r}=e,s=await L(`${this.url}/files/${r}`,{method:"DELETE",headers:this.generateAuthHeaders()});if(!s.ok)throw new Error(await s.text());return{error:null}}catch(r){return{error:r}}}setAccessToken(e){return this.accessToken=e,this}setAdminSecret(e){return this.adminSecret=e,this}generateAuthHeaders(){if(!(!this.adminSecret&&!this.accessToken))return this.adminSecret?{"x-hasura-admin-secret":this.adminSecret}:{Authorization:`Bearer ${this.accessToken}`}}}function E(t,e){if(!e||Object.keys(e).length===0)return t;const r=new URL(t),s=Object.entries(e).reduce((a,[o,i])=>({...a,[o.charAt(0)]:i}),{});return Object.entries(s).forEach(([a,o])=>{o&&r.searchParams.set(a,o)}),r.toString()}class w{constructor({url:e,adminSecret:r}){this.url=e,this.api=new R({url:e}),this.setAdminSecret(r)}async upload(e){return"file"in e?this.api.uploadFile(e):this.api.uploadFormData(e)}getPublicUrl(e){const{fileId:r,...s}=e;return E(`${this.url}/files/${r}`,s)}async getPresignedUrl(e){const{fileId:r,...s}=e,{presignedUrl:a,error:o}=await this.api.getPresignedUrl(e);if(o)return{presignedUrl:null,error:o};if(!a)return{presignedUrl:null,error:new Error("Invalid file id")};const i=E(a.url,s);return{presignedUrl:{...a,url:i},error:null}}async delete(e){const{error:r}=await this.api.delete(e);return r?{error:r}:{error:null}}setAccessToken(e){return this.api.setAccessToken(e),this}setAdminSecret(e){return this.api.setAdminSecret(e),this}}const m={progress:null,loaded:0,error:null,bucketId:void 0,file:void 0,id:void 0},I=()=>d.createMachine({predictableActionArguments:!0,schema:{context:{},events:{}},tsTypes:{},context:{...m},initial:"idle",on:{DESTROY:{actions:"sendDestroy",target:"stopped"}},states:{idle:{on:{ADD:{actions:"addFile"},UPLOAD:{cond:"hasFile",target:"uploading"}}},uploading:{entry:"resetProgress",on:{UPLOAD_PROGRESS:{actions:["incrementProgress","sendProgress"]},UPLOAD_DONE:"uploaded",UPLOAD_ERROR:"error",CANCEL:"idle"},invoke:{src:"uploadFile"}},uploaded:{entry:["setFileMetadata","sendDone"],on:{ADD:{actions:"addFile",target:"idle"},UPLOAD:{actions:"resetContext",target:"uploading"}}},error:{entry:["setError","sendError"],on:{ADD:{actions:"addFile",target:"idle"},UPLOAD:{actions:"resetContext",target:"uploading"}}},stopped:{type:"final"}}},{guards:{hasFile:(t,e)=>!!t.file||!!e.file},actions:{incrementProgress:d.assign({loaded:(t,{loaded:e})=>e,progress:(t,{progress:e})=>e}),setFileMetadata:d.assign({id:(t,{id:e})=>e,bucketId:(t,{bucketId:e})=>e,progress:t=>100}),setError:d.assign({error:(t,{error:e})=>e}),sendProgress:()=>{},sendError:()=>{},sendDestroy:()=>{},sendDone:()=>{},resetProgress:d.assign({progress:t=>null,loaded:t=>0}),resetContext:d.assign(t=>m),addFile:d.assign({file:(t,{file:e})=>e,bucketId:(t,{bucketId:e})=>e,id:(t,{id:e})=>e})},services:{uploadFile:(t,e)=>r=>{const s=e.file||t.file,a=new F;a.append("file[]",s);let o=0;return P(e.url,a,{fileId:e.id||t.id,bucketId:e.bucketId||t.bucketId,accessToken:e.accessToken,adminSecret:e.adminSecret,name:e.name||s.name,onUploadProgress:i=>{const l=i.total?Math.round(i.loaded*s.size/i.total):0,u=l-o;o=l,r({type:"UPLOAD_PROGRESS",progress:i.total?Math.round(l*100/i.total):0,loaded:l,additions:u})}}).then(({fileMetadata:i,error:l})=>{if(l&&r({type:"UPLOAD_ERROR",error:l}),i&&!("processedFiles"in i)){const{id:u,bucketId:p}=i;r({type:"UPLOAD_DONE",id:u,bucketId:p})}if(i&&"processedFiles"in i){const{id:u,bucketId:p}=i.processedFiles[0];r({type:"UPLOAD_DONE",id:u,bucketId:p})}}),()=>{}}}}),{pure:A,sendParent:h}=d.actions,M=()=>d.createMachine({id:"files-list",schema:{context:{},events:{}},tsTypes:{},predictableActionArguments:!0,context:{progress:null,files:[],loaded:0,total:0},initial:"idle",on:{UPLOAD:{cond:"hasFileToDownload",actions:"addItem",target:"uploading"},ADD:{actions:"addItem"},REMOVE:{actions:"removeItem"}},states:{idle:{entry:["resetProgress","resetLoaded","resetTotal"],on:{CLEAR:{actions:"clearList",target:"idle"}}},uploading:{entry:["upload","startProgress","resetLoaded","resetTotal"],on:{UPLOAD_PROGRESS:{actions:["incrementProgress"]},UPLOAD_DONE:[{cond:"isAllUploaded",target:"uploaded"},{cond:"isAllUploadedOrError",target:"error"}],UPLOAD_ERROR:[{cond:"isAllUploaded",target:"uploaded"},{cond:"isAllUploadedOrError",target:"error"}],CANCEL:{actions:"cancel",target:"idle"}}},uploaded:{entry:"setUploaded",on:{CLEAR:{actions:"clearList",target:"idle"}}},error:{on:{CLEAR:{actions:"clearList",target:"idle"}}}}},{guards:{hasFileToDownload:(t,e)=>t.files.some(r=>r.getSnapshot().matches("idle"))||!!e.files,isAllUploaded:t=>t.files.every(e=>{var r;return(r=e.getSnapshot())==null?void 0:r.matches("uploaded")}),isAllUploadedOrError:t=>t.files.every(e=>{const r=e.getSnapshot();return(r==null?void 0:r.matches("error"))||(r==null?void 0:r.matches("uploaded"))})},actions:{incrementProgress:d.assign((t,e)=>{const r=t.loaded+e.additions,s=Math.round(r*100/t.total);return{...t,loaded:r,progress:s}}),setUploaded:d.assign({progress:t=>100,loaded:({files:t})=>t.map(e=>e.getSnapshot()).filter(e=>e.matches("uploaded")).reduce((e,r)=>{var s;return e+((s=r.context.file)==null?void 0:s.size)},0)}),resetTotal:d.assign({total:({files:t})=>t.map(e=>e.getSnapshot()).filter(e=>!e.matches("uploaded")).reduce((e,r)=>{var s;return e+((s=r.context.file)==null?void 0:s.size)},0)}),resetLoaded:d.assign({loaded:t=>0}),startProgress:d.assign({progress:t=>0}),resetProgress:d.assign({progress:t=>null}),addItem:d.assign((t,{files:e,bucketId:r})=>{const s=e?Array.isArray(e)?e:"item"in e?Array.from(e):[e]:[],a=t.total+s.reduce((i,l)=>i+l.size,0),o=Math.round(t.loaded*100/a);return{files:[...t.files,...s.map(i=>d.spawn(I().withConfig({actions:{sendProgress:h((l,{additions:u})=>({type:"UPLOAD_PROGRESS",additions:u})),sendDone:h("UPLOAD_DONE"),sendError:h("UPLOAD_ERROR"),sendDestroy:h("REMOVE")}}).withContext({...m,file:i,bucketId:r}),{sync:!0}))],total:a,loaded:t.loaded,progress:o}}),removeItem:d.assign({files:t=>t.files.filter(e=>{var s,a;const r=(s=e.getSnapshot())==null?void 0:s.matches("stopped");return r&&((a=e.stop)==null||a.call(e)),!r})}),clearList:A(t=>t.files.map(e=>d.send({type:"DESTROY"},{to:e.id}))),upload:A((t,e)=>t.files.map(r=>d.send(e,{to:r.id}))),cancel:A(t=>t.files.map(e=>d.send({type:"CANCEL"},{to:e.id})))}}),k=async(t,e)=>new Promise(r=>{e.send({type:"UPLOAD",...t}),e.subscribe(s=>{var a;s.matches("error")?r({error:s.context.error,isError:!0,isUploaded:!1}):s.matches("uploaded")&&r({error:null,isError:!1,isUploaded:!0,id:s.context.id,bucketId:s.context.id,name:(a=s.context.file)==null?void 0:a.name})})}),b=async(t,e)=>new Promise(r=>{e.send({type:"UPLOAD",...t,files:t.files}),e.onTransition(s=>{s.matches("error")?r({errors:s.context.files.filter(a=>{var o;return(o=a.getSnapshot())==null?void 0:o.context.error}),isError:!0,files:[]}):s.matches("uploaded")&&r({errors:[],isError:!1,files:s.context.files})})});exports.HasuraStorageApi=R;exports.HasuraStorageClient=w;exports.INITIAL_FILE_CONTEXT=m;exports.appendImageTransformationParameters=E;exports.createFileUploadMachine=I;exports.createMultipleFilesUploadMachine=M;exports.uploadFilePromise=k;exports.uploadMultipleFilesPromise=b;
//# sourceMappingURL=index.cjs.js.map
