{"version":3,"file":"index.esm.js","sources":["../src/utils.ts","../src/create-server-side-client.ts","../src/get-session.ts","../src/index.ts"],"sourcesContent":["import { NhostClient, NhostSession } from '@nhost/react'\nimport fetch from 'isomorphic-unfetch'\nimport Cookies from 'js-cookie'\n\nexport const refresh = async (nhostUrl: string, refreshToken: string): Promise<NhostSession> => {\n  const result = await fetch(`${nhostUrl}/v1/auth/token`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({ refreshToken })\n  })\n  if (result.ok) {\n    return result.json()\n  }\n  return Promise.reject(result.statusText)\n}\n\nexport const NHOST_SESSION_KEY = 'nhostSession'\n\nexport const setNhostSessionInCookie = (param: NhostClient | NhostSession | null) => {\n  const session = param && 'auth' in param ? param.auth.getSession() : param\n  if (!session) {\n    Cookies.remove(NHOST_SESSION_KEY)\n    return\n  }\n  const { refreshToken, ...rest } = session\n  const expires = new Date()\n  // * Expire the cookie 60 seconds before the token expires\n  expires.setSeconds(expires.getSeconds() + session.accessTokenExpiresIn - 60)\n  Cookies.set(NHOST_SESSION_KEY, JSON.stringify(rest), {\n    sameSite: 'strict',\n    expires\n  })\n}\n","import {\n  AuthMachine,\n  NHOST_REFRESH_TOKEN_KEY,\n  NhostClient,\n  NhostReactClientConstructorParams,\n  NhostSession,\n  VanillaNhostClient\n} from '@nhost/react'\nimport Cookies from 'js-cookie'\nimport { GetServerSidePropsContext } from 'next'\nimport { StateFrom } from 'xstate'\nimport { waitFor } from 'xstate/lib/waitFor'\nimport { NHOST_SESSION_KEY } from './utils'\n\nexport type CreateServerSideClientParams = Partial<\n  Pick<\n    NhostReactClientConstructorParams,\n    'subdomain' | 'region' | 'authUrl' | 'functionsUrl' | 'graphqlUrl' | 'storageUrl'\n  >\n>\n\n/**\n * Creates an Nhost client that runs on the server side.\n * It will try to get the refesh token in cookies, or from the request URL\n * If a refresh token is found, it uses it to get an up to date access token (JWT) and a user session\n * This method resolves when the authentication status is known eventually\n * @param config - An object containing connection information\n * @param context - Server side context\n * @returns instance of `NhostClient` that is ready to use on the server side (signed in or signed out)\n */\nexport const createServerSideClient = async (\n  params: string | CreateServerSideClientParams,\n  context: GetServerSidePropsContext\n): Promise<NhostClient> => {\n  let clientParams: NhostReactClientConstructorParams\n\n  if (typeof params === 'string') {\n    console.warn(\n      'Deprecation Notice: Backend URL is no longer supported. Please use subdomain + region or individual service URLs.'\n    )\n\n    clientParams = {\n      backendUrl: params\n    }\n  } else {\n    clientParams = {\n      ...params\n    }\n  }\n\n  const nhost = new VanillaNhostClient({\n    ...clientParams,\n    clientStorageType: 'custom',\n    clientStorage: {\n      getItem: (key) => {\n        // TODO does not perfectly work in the same way as the 'regular' client:\n        // in the authentication machine, if the refresh token is null but an error is found in the url, then the authentication stops and fails.\n        // * When the requested key is `NHOST_REFRESH_TOKEN_KEY`, we have to look for the given 'refreshToken' value\n        // * in the url as this is the key sent by hasura-auth\n        const urlKey = key === NHOST_REFRESH_TOKEN_KEY ? 'refreshToken' : key\n        const urlValue = context.query[urlKey]\n        const cookieValue = Cookies.get(key) ?? null\n        const nextCtxValue = context.req.cookies[key]\n\n        return typeof urlValue === 'string' ? urlValue : cookieValue ?? nextCtxValue\n      },\n      setItem: (key, value) => {\n        // TODO: Set expires based on the actual refresh token expire time\n        // For now, we're using 30 days so the cookie is not removed when the browser is closed because if `expiers` is omitted, the cookie becomes a session cookie.\n        Cookies.set(key, value, { httpOnly: false, sameSite: 'strict', expires: 30 })\n      },\n      removeItem: (key) => {\n        Cookies.remove(key)\n      }\n    },\n    start: false,\n    autoRefreshToken: false,\n    autoSignIn: true\n  })\n\n  const strSession = context.req.cookies[NHOST_SESSION_KEY]\n  const refreshToken = context.req.cookies[NHOST_REFRESH_TOKEN_KEY]\n  const initialSession: NhostSession = strSession &&\n    refreshToken && { ...JSON.parse(strSession), refreshToken }\n\n  nhost.auth.client.start({ initialSession })\n  await waitFor(\n    nhost.auth.client.interpreter!,\n    (state: StateFrom<AuthMachine>) => !state.hasTag('loading')\n  )\n  return nhost\n}\n","import { NhostSession } from '@nhost/react'\nimport { GetServerSidePropsContext } from 'next'\nimport { createServerSideClient, CreateServerSideClientParams } from './create-server-side-client'\n\n/**\n * Refreshes the access token if there is any and returns the Nhost session.\n *\n * @example\n * ### Using an arrow function\n *\n * ```js\n * export const getServerSideProps: GetServerSideProps = async (context) => {\n *   const nhostSession = await getNhostSession(\n *     { subdomain: '<project_subdomain>', region: '<project_region>' },\n *     context\n *   )\n *\n *   return {\n *     props: {\n *       nhostSession\n *     }\n *   }\n * }\n * ```\n *\n * @example\n * ### Using a regular function\n *\n * ```js\n * export async function getServerSideProps(context: GetServerSidePropsContext) { // or NextPageContext\n *   const nhostSession = await getNhostSession(\n *     { subdomain: '<project_subdomain>', region: '<project_region>' },\n *     context\n *   )\n *\n *   return {\n *     props: {\n *       nhostSession\n *     }\n *   }\n * }\n * ```\n *\n * @param backendUrl - URL of your Nhost application\n * @param context - Next.js context\n * @returns Nhost session\n */\nexport const getNhostSession = async (\n  params: string | CreateServerSideClientParams,\n  context: GetServerSidePropsContext\n): Promise<NhostSession | null> => {\n  const nhost = await createServerSideClient(params, context)\n  const { accessToken, refreshToken, user } = nhost.auth.client.interpreter!.getSnapshot().context\n  return nhost.auth.isAuthenticated()\n    ? {\n        accessToken: accessToken.value!,\n        accessTokenExpiresIn: (accessToken.expiresAt!.getTime() - Date.now()) / 1_000,\n        refreshToken: refreshToken.value!,\n        user: user!\n      }\n    : null\n}\n","import {\n  NhostClient as ReactNhostClient,\n  NhostProvider,\n  NhostReactClientConstructorParams\n} from '@nhost/react'\nimport { setNhostSessionInCookie } from './utils'\n\nexport * from '@nhost/react'\nexport * from './create-server-side-client'\nexport * from './get-session'\n/**\n * @deprecated use `NhostProvider` instead\n */\nexport const NhostNextProvider: typeof NhostProvider = NhostProvider\n\nconst isBrowser = typeof window !== 'undefined'\n\nexport interface NhostNextClientConstructorParams\n  extends Omit<\n    NhostReactClientConstructorParams,\n    'clientStorage' | 'clientStorageType' | 'clientStorageGetter' | 'clientStorageSetter'\n  > {}\n\nexport class NhostClient extends ReactNhostClient {\n  constructor(params: NhostNextClientConstructorParams) {\n    super({\n      ...params,\n      autoSignIn: isBrowser && params.autoSignIn,\n      autoRefreshToken: isBrowser && params.autoRefreshToken,\n      clientStorageType: 'cookie'\n    })\n\n    this.auth.onAuthStateChanged(() => {\n      setNhostSessionInCookie(this)\n    })\n    this.auth.onTokenChanged(setNhostSessionInCookie)\n  }\n}\n"],"names":["NHOST_SESSION_KEY","setNhostSessionInCookie","param","session","Cookies","refreshToken","rest","expires","createServerSideClient","params","context","clientParams","nhost","VanillaNhostClient","key","urlKey","NHOST_REFRESH_TOKEN_KEY","urlValue","cookieValue","_a","nextCtxValue","value","strSession","initialSession","waitFor","state","getNhostSession","accessToken","user","NhostNextProvider","NhostProvider","isBrowser","NhostClient","ReactNhostClient"],"mappings":"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"}